<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebFine SEO Audit - Premium Sonu√ßlar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#4f46e5',
                        secondary: '#9333ea',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .radial-progress {
            position: relative;
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background: conic-gradient(var(--color) var(--percent), #e2e8f0 0);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 1s ease-out;
        }

        .radial-progress::before {
            content: '';
            position: absolute;
            width: 115px;
            height: 115px;
            background: white;
            border-radius: 50%;
        }

        .radial-value {
            position: relative;
            font-size: 3rem;
            font-weight: 800;
            color: var(--text-color);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .blur-bg {
            filter: blur(8px);
            pointer-events: none;
            user-select: none;
        }

        .mandatory-modal {
            pointer-events: auto !important;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-900 min-h-screen flex flex-col">
    <div id="mainContent">
        <!-- Navbar -->
        <nav class="bg-white/80 backdrop-blur-md sticky top-0 z-50 border-b border-slate-200">
            <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
                <div
                    class="text-2xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600">
                    WEBFINE
                </div>
                <div class="flex items-center gap-6">
                    <!-- Language Switcher -->
                    <div class="bg-slate-100 p-1 rounded-lg flex gap-1">
                        <button onclick="setLanguage('tr')" id="lang-tr"
                            class="px-3 py-1 text-xs font-bold rounded-md transition-all">TR</button>
                        <button onclick="setLanguage('en')" id="lang-en"
                            class="px-3 py-1 text-xs font-bold rounded-md transition-all">EN</button>
                    </div>
                    <div class="hidden md:block text-sm font-semibold text-slate-500">LEAD GEN MODE</div>
                </div>
            </div>
        </nav>

        <!-- Hero -->
        <main class="flex-grow">
            <section class="py-12 md:py-20 relative overflow-hidden">
                <div class="absolute inset-0 bg-gradient-to-b from-blue-50 to-white -z-10"></div>
                <div class="max-w-4xl mx-auto px-6 text-center">
                    <h1 class="text-4xl md:text-6xl font-extrabold tracking-tight mb-6 text-slate-900"
                        id="t-hero-title">
                        Web Sitenizin <span
                            class="bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-purple-600">Ger√ßek
                            G√ºc√ºn√º</span> Ke≈üfedin
                    </h1>
                    <p class="text-lg md:text-xl text-slate-600 mb-10 max-w-2xl mx-auto" id="t-hero-subtitle">
                        Yapay zeka destekli altyapƒ±mƒ±z ile saniyeler i√ßinde kapsamlƒ± SEO ve performans analizi yapƒ±n.
                    </p>

                    <!-- Form Card -->
                    <div
                        class="bg-white rounded-2xl shadow-xl shadow-blue-900/5 p-6 md:p-8 max-w-2xl mx-auto border border-slate-100 ring-1 ring-slate-900/5">
                        <form id="initialForm" onsubmit="openModal(event)" class="space-y-6">
                            <div class="relative group">
                                <input type="url" id="urlInput" required placeholder="https://ornek-site.com"
                                    class="w-full bg-slate-50 border border-slate-200 rounded-xl px-6 py-4 pl-12 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all text-lg group-hover:bg-white"
                                    value="https://google.com">
                                <div
                                    class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-blue-500 transition-colors">
                                    üåê
                                </div>
                            </div>

                            <button type="submit" id="t-btn-analyze"
                                class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-600/20 transform transition-all active:scale-[0.98] flex justify-center items-center gap-2 text-lg">
                                <span>‚ö°</span> √úcretsiz Analiz Et
                            </button>
                        </form>
                    </div>
                </div>
            </section>

            <!-- Results Section -->
            <section id="resultsSection" class="hidden py-12 bg-slate-50 min-h-[500px]">
                <div class="max-w-6xl mx-auto px-6 animate-fade-in-up">

                    <!-- Summary Stats -->
                    <div class="grid md:grid-cols-3 gap-6 mb-8">
                        <!-- Score Card -->
                        <div
                            class="bg-white rounded-2xl p-8 shadow-lg border border-slate-100 flex flex-col items-center justify-center col-span-1 relative overflow-hidden">
                            <div class="text-slate-500 uppercase tracking-widest text-xs font-bold mb-2"
                                id="t-score-label">
                                GENEL SKOR</div>
                            <div id="healthBadge"
                                class="mb-4 px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-wider bg-slate-100 text-slate-500">
                                Loading...</div>
                            <div id="scoreCircle" class="radial-progress shadow-inner"
                                style="--color: #10b981; --percent: 0%; --text-color: #059669;">
                                <div class="radial-value" id="scoreDisplay">0</div>
                            </div>

                            <!-- Scale Legend -->
                            <div class="mt-6 flex justify-between w-full px-4 text-xs font-medium text-slate-400">
                                <div class="flex flex-col items-center gap-1"><span
                                        class="w-2 h-2 rounded-full bg-rose-500"></span>0-49</div>
                                <div class="flex flex-col items-center gap-1"><span
                                        class="w-2 h-2 rounded-full bg-amber-500"></span>50-89</div>
                                <div class="flex flex-col items-center gap-1"><span
                                        class="w-2 h-2 rounded-full bg-emerald-500"></span>90-100</div>
                            </div>
                        </div>

                        <!-- Details Stats -->
                        <div class="md:col-span-2 grid grid-cols-2 gap-4">
                            <div class="bg-blue-50 rounded-2xl p-6 flex flex-col justify-center border border-blue-100">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-4xl font-bold text-blue-600" id="totalPages">0</span>
                                    <span class="text-2xl opacity-20">üìÑ</span>
                                </div>
                                <span class="text-sm text-slate-600 font-medium uppercase tracking-wide"
                                    id="t-pages-label">Taranan Sayfa</span>
                            </div>
                            <div
                                class="bg-emerald-50 rounded-2xl p-6 flex flex-col justify-center border border-emerald-100">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-4xl font-bold text-emerald-600" id="t-speed-val">~0.2s</span>
                                    <span class="text-2xl opacity-20">‚ö°</span>
                                </div>
                                <span class="text-sm text-slate-600 font-medium uppercase tracking-wide"
                                    id="t-speed-label">Ort. Hƒ±z</span>
                            </div>

                            <!-- Improvements Card -->
                            <div onclick="openImprovementsModal()"
                                class="col-span-2 bg-amber-50 rounded-2xl p-6 flex flex-col justify-center border border-amber-100 cursor-pointer hover:shadow-md transition-all group relative overflow-hidden">
                                <div class="flex items-center gap-3 mb-1">
                                    <span id="improvements" class="text-4xl font-bold text-amber-600">0</span>
                                    <span
                                        class="bg-amber-200 text-amber-800 text-xs px-2 py-1 rounded-full font-bold uppercase"
                                        id="t-badge-critical">√ñNEMLƒ∞</span>
                                </div>
                                <span class="text-sm text-slate-600 font-medium uppercase tracking-wide"
                                    id="t-issues-label">ƒ∞yile≈ütirme √ñnerisi</span>
                            </div>
                        </div>
                    </div>

                    <!-- Page Details List (Hidden until lead) -->
                    <div id="fullReportContainer" class="hidden">
                        <div class="bg-white rounded-2xl shadow-xl border border-slate-100 overflow-hidden">
                            <div class="bg-slate-50/50 px-6 py-4 border-b border-slate-100">
                                <h3 class="font-bold text-lg text-slate-800" id="t-details-label">Sayfa Detaylarƒ±</h3>
                            </div>
                            <div id="detailsList" class="divide-y divide-slate-100"></div>
                        </div>
                    </div>

                    <!-- Blur placeholder for preview mode -->
                    <div id="reportPlaceholder"
                        class="bg-white rounded-2xl p-12 text-center border-2 border-dashed border-slate-200 text-slate-400 font-bold uppercase tracking-widest">
                        Tam Rapor Payla≈üƒ±ldƒ±ƒüƒ±nda Burada G√∂r√ºnecek
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- LEAD GEN MODAL (Hard Gate) -->
    <div id="leadModal" class="fixed inset-0 z-[100] hidden">
        <div class="fixed inset-0 bg-slate-900/40 backdrop-blur-md transition-opacity opacity-0" id="modalBackdrop">
        </div>
        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4 text-center">
                <div class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-2xl transition-all w-full max-w-md opacity-0 scale-95 mandatory-modal"
                    id="modalPanel">
                    <div class="bg-white px-8 py-10">
                        <div class="text-center">
                            <div
                                class="mx-auto flex h-20 w-20 items-center justify-center rounded-full bg-blue-50 mb-6">
                                <svg class="h-10 w-10 text-blue-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <h3 class="text-3xl font-black leading-tight text-slate-900 mb-2" id="t-popup-title">Detaylƒ±
                                SEO Raporunuz Hazƒ±r</h3>
                            <p class="text-sm text-slate-500 mb-8" id="t-popup-desc">Hƒ±zlƒ± √∂n analiz tamamlandƒ±. Detaylƒ±
                                teknik raporu g√∂r√ºnt√ºlemek i√ßin e-posta adresinizi girin.</p>

                            <form id="leadForm" onsubmit="handleAudit(event)">
                                <div class="relative rounded-md shadow-sm mb-4">
                                    <div class="absolute inset-y-0 left-0 flex items-center pl-3">
                                        <span class="text-slate-400">@</span>
                                    </div>
                                    <input type="email" id="emailInput" required
                                        class="block w-full rounded-xl border-0 py-3.5 pl-10 text-slate-900 ring-1 ring-inset ring-slate-200 focus:ring-2 focus:ring-blue-600 bg-slate-50">
                                </div>

                                <div class="flex flex-col gap-3">
                                    <button type="submit" id="t-popup-primary"
                                        class="w-full rounded-xl bg-blue-600 px-3 py-3.5 text-sm font-bold text-white shadow-lg shadow-blue-600/20 active:scale-[0.98]">Sonu√ßlarƒ±
                                        G√∂ster</button>
                                    <p class="text-[10px] text-slate-400 mt-2 text-center" id="t-trust-line">√úcretsiz
                                        analiz ‚Ä¢ Spam yok ‚Ä¢ WebFine g√ºvencesi</p>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- IMPROVEMENTS MODAL -->
    <div id="improvementsModal" class="fixed inset-0 z-[100] hidden">
        <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity"
            onclick="closeImprovementsModal()"></div>
        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4">
                <div
                    class="relative transform rounded-2xl bg-white text-left shadow-2xl transition-all w-full max-w-2xl">
                    <div
                        class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50 rounded-t-2xl">
                        <h3 class="text-lg font-bold text-slate-800" id="t-issues-modal-title">ƒ∞yile≈ütirme Fƒ±rsatlarƒ±
                        </h3>
                        <button onclick="closeImprovementsModal()" class="text-slate-400 hover:text-slate-600">
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <div class="p-6 max-h-[70vh] overflow-y-auto" id="improvementsList"></div>
                    <div class="p-6 bg-slate-50 rounded-b-2xl border-t border-slate-100">
                        <div
                            class="bg-blue-50 border border-blue-100 rounded-lg p-4 flex flex-col md:flex-row gap-4 items-center">
                            <div class="flex-shrink-0 text-2xl">üí°</div>
                            <div class="text-center md:text-left">
                                <h4 class="font-bold text-blue-900 text-sm" id="t-support-title">Profesyonel Destek</h4>
                                <p class="text-sm text-blue-700 mt-1" id="t-support-desc">Bu sorunlarƒ± sizin i√ßin
                                    √ß√∂zebiliriz.</p>
                            </div>
                            <a href="#"
                                class="md:ml-auto bg-blue-600 text-white px-6 py-2 rounded-lg text-sm font-bold hover:bg-blue-700"
                                id="t-support-btn">Teklif Al</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentLang = 'tr';
        let fullReportData = null;
        let isLeadCaptured = false;

        // DEFAULT LABELS (Turkish) - Ensures the button works even if fetch fails
        let labels = {
            hero_title: 'Web Sitenizin <span class="bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-purple-600">Ger√ßek G√ºc√ºn√º</span> Ke≈üfedin',
            hero_subtitle: "Yapay zeka destekli altyapƒ±mƒ±z ile saniyeler i√ßinde kapsamlƒ± SEO ve performans analizi yapƒ±n.",
            btn_analyze: "<span>‚ö°</span> √úcretsiz Analiz Et",
            score_label: "GENEL SKOR",
            pages_label: "Taranan Sayfa",
            speed_label: "Ort. Hƒ±z",
            issues_label: "ƒ∞yile≈ütirme √ñnerisi",
            details_label: "Sayfa Detaylarƒ±",
            popup_title: "Detaylƒ± SEO Raporunuz Hazƒ±r",
            popup_desc: "Hƒ±zlƒ± √∂n analiz tamamlandƒ±. Detaylƒ± teknik raporu g√∂r√ºnt√ºlemek i√ßin e-posta adresinizi girin.",
            popup_primary: "üöÄ Detaylƒ± Raporu A√ß",
            trust_line: "√úcretsiz analiz ‚Ä¢ Spam yok ‚Ä¢ WebFine g√ºvencesi",
            badge_critical: "√ñNEMLƒ∞",
            issues_modal_title: "Tespit Edilen ƒ∞yile≈ütirme Fƒ±rsatlarƒ±",
            support_title: "Profesyonel Destek",
            support_desc: "Bu teknik sorunlarƒ± sizin i√ßin √ß√∂zebiliriz.",
            support_btn: "Teklif Al",
            not_found: "Harika! Ciddi bir sorun tespit edilemedi. üéâ",
            analyzing: "Analiz Ediliyor...",
            saving: "Doƒürulanƒ±yor...",
            health_critical: "Kritik",
            health_needs_optimization: "ƒ∞yile≈ütirme Gerekli",
            health_high_potential: "Y√ºksek Potansiyel",
            loading_messages: [
                "üß† Yapay zeka site yapƒ±nƒ±zƒ± analiz ediyor...",
                "üîç Meta etiketleri ve ba≈ülƒ±k yapƒ±sƒ± inceleniyor...",
                "‚öôÔ∏è Teknik SEO hatalarƒ± tespit ediliyor...",
                "üìä Performans ve hƒ±z metrikleri √∂l√ß√ºl√ºyor...",
                "üõ† ƒ∞ndeksleme ve y√∂nlendirmeler kontrol ediliyor...",
                "üöÄ Detaylƒ± rapor olu≈üturuluyor..."
            ]
        };

        async function fetchLocale(lang) {
            try {
                const res = await fetch(`/api/locales/${lang}`);
                if (!res.ok) throw new Error('API locale failed');
                const newLabels = await res.json();
                labels = { ...labels, ...newLabels };
                applyLabels();
            } catch (err) {
                console.warn('Backend locales not ready, using defaults', err);
                applyLabels(); // Still apply what we have
            }
        }

        function applyLabels() {
            if (!labels.hero_title) return;

            document.getElementById('t-hero-title').innerHTML = labels.hero_title;
            document.getElementById('t-hero-subtitle').innerText = labels.hero_subtitle;
            document.getElementById('t-btn-analyze').innerHTML = labels.btn_analyze;
            document.getElementById('t-score-label').innerText = labels.score_label;
            document.getElementById('t-pages-label').innerText = labels.pages_label;
            document.getElementById('t-speed-label').innerText = labels.speed_label;
            document.getElementById('t-issues-label').innerText = labels.issues_label;
            document.getElementById('t-details-label').innerText = labels.details_label;
            document.getElementById('t-popup-title').innerText = labels.popup_title;
            document.getElementById('t-popup-desc').innerText = labels.popup_desc;
            document.getElementById('t-popup-primary').innerText = labels.popup_primary;
            document.getElementById('t-trust-line').innerText = labels.trust_line;
            document.getElementById('t-badge-critical').innerText = labels.badge_critical;
            document.getElementById('t-issues-modal-title').innerText = labels.issues_modal_title;
            document.getElementById('t-support-title').innerText = labels.support_title;
            document.getElementById('t-support-desc').innerText = labels.support_desc;
            document.getElementById('t-support-btn').innerText = labels.support_btn;

            // Update Active Lang Buttons
            document.getElementById('lang-tr').className = currentLang === 'tr' ? 'px-3 py-1 text-xs font-bold rounded-md bg-white shadow-sm text-blue-600' : 'px-3 py-1 text-xs font-bold rounded-md text-slate-400 hover:text-slate-600';
            document.getElementById('lang-en').className = currentLang === 'en' ? 'px-3 py-1 text-xs font-bold rounded-md bg-white shadow-sm text-blue-600' : 'px-3 py-1 text-xs font-bold rounded-md text-slate-400 hover:text-slate-600';

            if (fullReportData) updateUI(fullReportData);
        }

        async function setLanguage(lang) {
            currentLang = lang;
            document.documentElement.lang = lang;
            await fetchLocale(lang);
        }

        // URL Normalization for better UX
        document.getElementById('urlInput').addEventListener('blur', (e) => {
            let val = e.target.value.trim();
            if (val && !val.startsWith('http')) {
                e.target.value = 'https://' + val;
            }
        });

        // Initialize Lang
        setLanguage('tr');

        // Handle Query Parameters (from widget/external)
        window.addEventListener('load', () => {
            const params = new URLSearchParams(window.location.search);
            const queryUrl = params.get('url');
            const queryLang = params.get('lang');

            if (queryLang && (queryLang === 'tr' || queryLang === 'en')) {
                setLanguage(queryLang);
            }

            if (queryUrl) {
                document.getElementById('urlInput').value = queryUrl;
                // Optional: Auto-start audit if Turnstile is not required immediately
                // For now, just pre-fill to avoid bot-spam.
            }
        });

        // Prevent ESC key from closing modal
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !document.getElementById('leadModal').classList.contains('hidden')) {
                e.preventDefault();
                e.stopPropagation();
            }
        });

        let loadingInterval;
        async function openModal(e) {
            e.preventDefault();
            const url = document.getElementById('urlInput').value.trim();
            const submitBtn = document.getElementById('t-btn-analyze');
            const originalBtnText = submitBtn.innerHTML;

            submitBtn.disabled = true;

            // Start dynamic loading messages
            let msgIndex = 0;
            const msgs = labels.loading_messages || [labels.analyzing];

            const updateBtnLoading = () => {
                submitBtn.innerHTML = `
                    <div class="flex flex-col items-center justify-center gap-1">
                        <div class="flex items-center gap-3">
                            <svg class="animate-spin h-5 w-5 text-white" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span class="text-sm font-medium animate-pulse">${msgs[msgIndex]}</span>
                        </div>
                        <span class="text-[10px] opacity-60 font-bold uppercase tracking-widest">${currentLang === 'tr' ? 'Hƒ±zlƒ± √ñn Analiz (8 Sayfa)' : 'Quick Audit (8 Pages)'}</span>
                    </div>
                `;
                msgIndex = (msgIndex + 1) % msgs.length;
            };

            updateBtnLoading();
            loadingInterval = setInterval(updateBtnLoading, 2800);

            try {
                // Get Turnstile token
                let turnstileToken = '';
                try {
                    if (typeof turnstile !== 'undefined') {
                        turnstileToken = turnstile.getResponse();
                    } else if (typeof grecaptcha !== 'undefined' && grecaptcha.getResponse) {
                        turnstileToken = grecaptcha.getResponse();
                    }
                } catch (e) { }

                if (!turnstileToken) {
                    turnstileToken = document.querySelector('[name="cf-turnstile-response"]')?.value || 'mock-token';
                }

                const res = await fetch('/api/audit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url, turnstileToken, lang: currentLang })
                });

                const data = await res.json();
                if (!data.success) throw new Error(data.message || 'Hata');

                fullReportData = data;
                isLeadCaptured = false;

                // Show Results Preview
                updateUI(data);

                const modal = document.getElementById('leadModal');
                const backdrop = document.getElementById('modalBackdrop');
                const panel = document.getElementById('modalPanel');
                const main = document.getElementById('mainContent');

                modal.classList.remove('hidden');
                main.classList.add('blur-bg');
                setTimeout(() => { backdrop.classList.remove('opacity-0'); panel.classList.remove('opacity-0', 'scale-95'); }, 10);
            } catch (err) {
                alert(err.message);
            } finally {
                clearInterval(loadingInterval);
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            }
        }

        async function handleAudit(e) {
            e.preventDefault();
            const btn = document.getElementById('t-popup-primary');
            const emailInput = document.getElementById('emailInput');
            const email = emailInput.value.trim();

            if (!email || !email.includes('@')) {
                emailInput.classList.add('ring-red-500');
                return;
            }

            if (!fullReportData) {
                alert("Report data missing. Please refresh.");
                return;
            }

            const originalBtnText = btn.innerText;
            btn.disabled = true;
            btn.innerText = labels.saving || "Verifying...";

            try {
                const res = await fetch('/api/lead', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email,
                        lang: currentLang,
                        site: fullReportData.site,
                        score: fullReportData.score,
                        errors: fullReportData.summary.errors,
                        warnings: fullReportData.summary.warnings,
                        pagesAudited: fullReportData.pagesAudited,
                        durationMs: fullReportData.durationMs,
                        healthLevel: fullReportData.healthLevel
                    })
                });

                const data = await res.json();
                if (!data.success) throw new Error(data.message);

                isLeadCaptured = true;
                const backdrop = document.getElementById('modalBackdrop');
                const panel = document.getElementById('modalPanel');
                const main = document.getElementById('mainContent');

                backdrop.classList.add('opacity-0');
                panel.classList.add('opacity-0', 'scale-95');
                main.classList.remove('blur-bg');

                setTimeout(() => {
                    document.getElementById('leadModal').classList.add('hidden');
                    updateUI(fullReportData);
                }, 300);
            } catch (err) {
                alert(err.message);
                btn.disabled = false;
                btn.innerText = originalBtnText || labels.popup_primary;
            }
        }

        function updateUI(r) {
            const section = document.getElementById('resultsSection');
            section.classList.remove('hidden');

            const score = Math.round(r.score);
            document.getElementById('scoreDisplay').innerText = score;
            const circle = document.getElementById('scoreCircle');

            // Health Badge
            const badge = document.getElementById('healthBadge');
            let healthKey = score < 60 ? 'health_critical' : score < 80 ? 'health_needs_optimization' : 'health_high_potential';
            badge.innerText = labels[healthKey] || r.healthLevel || "Audit Result";
            badge.className = `mb-4 px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-wider ${score < 60 ? 'bg-rose-100 text-rose-600' : score < 80 ? 'bg-amber-100 text-amber-600' : 'bg-emerald-100 text-emerald-600'}`;

            setTimeout(() => {
                circle.style.setProperty('--percent', score + '%');
                circle.style.setProperty('--color', score >= 90 ? '#10b981' : score >= 50 ? '#f59e0b' : '#ef4444');
                circle.style.setProperty('--text-color', score >= 90 ? '#059669' : score >= 50 ? '#d97706' : '#dc2626');
            }, 100);

            document.getElementById('totalPages').innerText = r.pagesAudited;
            document.getElementById('improvements').innerText = r.summary.errors + r.summary.warnings;

            // Dynamic Speed update
            const avgSpeed = (r.durationMs / (r.pagesAudited || 1) / 1000).toFixed(2);
            document.getElementById('t-speed-val').innerText = `~${avgSpeed}s`;

            // Report visibility
            const reportContainer = document.getElementById('fullReportContainer');
            const placeholder = document.getElementById('reportPlaceholder');

            if (isLeadCaptured) {
                reportContainer.classList.remove('hidden');
                placeholder.classList.add('hidden');
                renderFullReport(r.report);
            } else {
                reportContainer.classList.add('hidden');
                placeholder.classList.remove('hidden');
            }

            setTimeout(() => {
                const target = isLeadCaptured ? document.getElementById('fullReportContainer') : section;
                target.scrollIntoView({ behavior: 'smooth' });
            }, 300);
        }

        function renderFullReport(report) {
            const list = document.getElementById('detailsList');
            list.innerHTML = '';

            report.forEach(page => {
                const color = page.score >= 90 ? 'text-emerald-500' : page.score >= 50 ? 'text-amber-500' : 'text-rose-500';
                const item = document.createElement('div');
                item.className = 'p-6 hover:bg-slate-50 flex flex-col md:flex-row md:items-center justify-between gap-4 transition-colors';

                const getIcon = (check) => page.issues.some(i => i.message.includes(check))
                    ? `<svg class="w-4 h-4 text-amber-500 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>`
                    : `<svg class="w-4 h-4 text-emerald-500 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>`;

                item.innerHTML = `
                    <div class="flex-1 min-w-0">
                        <a href="${page.url}" target="_blank" class="text-blue-600 hover:underline font-semibold block truncate mb-1">${page.url}</a>
                        <div class="flex gap-4 text-sm text-slate-500">
                            <span>${getIcon('Title')} Meta</span>
                            <span>${getIcon('H1')} H1</span>
                            <span>${getIcon('images')} Img</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-medium text-slate-400">Score</span>
                        <span class="text-3xl font-bold ${color}">${page.score}</span>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function openImprovementsModal() {
            if (!fullReportData || !isLeadCaptured) {
                if (!isLeadCaptured && fullReportData) {
                    document.getElementById('leadModal').classList.remove('hidden');
                    document.getElementById('mainContent').classList.add('blur-bg');
                }
                return;
            }
            const modal = document.getElementById('improvementsModal');
            const list = document.getElementById('improvementsList');
            list.innerHTML = '';
            let issuesFound = false;

            fullReportData.report.forEach(page => {
                if (page.issues.length > 0) {
                    issuesFound = true;
                    const block = document.createElement('div');
                    block.className = 'bg-white border-l-4 border-rose-500 rounded p-4 mb-4 shadow-sm';
                    block.innerHTML = `
                        <div class="font-bold text-slate-800 mb-2 border-b pb-2">${page.url}</div>
                        <ul class="space-y-2">
                            ${page.issues.map(i => `<li class="flex items-start gap-2 text-sm text-slate-600"><span class="${i.type === 'error' ? 'text-rose-500' : 'text-amber-500'}">‚ö†Ô∏è</span><span>${i.message}</span></li>`).join('')}
                        </ul>
                    `;
                    list.appendChild(block);
                }
            });

            if (!issuesFound) list.innerHTML = `<div class="text-center py-10 text-slate-500">${labels.not_found}</div>`;
            modal.classList.remove('hidden');
        }

        function closeImprovementsModal() { document.getElementById('improvementsModal').classList.add('hidden'); }
    </script>
</body>

</html>